<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Math Snake Game</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #F0F0F0; font-family: Arial, sans-serif; }
        #game-container { position: relative; }
        canvas { border: 1px solid #333; background: #E0E0E0; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #form { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; }
        table { border-collapse: collapse; }
        td { padding: 5px; }
        #question { margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas"></canvas>
        <div id="ui">
            <div id="question"></div>
            <table id="players-list"></table>
        </div>
    </div>
    <div id="overlay">
        <div id="form">
            <h2>Join Game</h2>
            <input type="text" id="name" placeholder="Your name" required><br><br>
            <select id="color">
                <option value="red">Red</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
                <option value="purple">Purple</option>
                <option value="orange">Orange</option>
            </select><br><br>
            <button onclick="joinGame()">Join</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
        const socket = io("https://snake-server-7quw.onrender.com"); // Replace with your server URL
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const overlay = document.getElementById("overlay");
        const nameInput = document.getElementById("name");
        const colorSelect = document.getElementById("color");
        const playersList = document.getElementById("players-list");
        const questionDiv = document.getElementById("question");

        const gridSize = 10;
        let players = {};
        let me = {};
        let segments = [{ x: 0, y: 0 }]; // Initial position
        let dx = gridSize, dy = 0; // Start moving right
        let foodItems = [];
        let isActive = true;
        let gameLoopId = null;

        // Resize canvas to fit grid
        function resizeCanvas() {
            const maxSize = Math.min(window.innerWidth * 0.9, 600);
            const size = Math.floor(maxSize / gridSize) * gridSize;
            canvas.width = size;
            canvas.height = size;
            ctx.font = `${Math.floor(gridSize / 2)}px sans-serif`;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // Join game
        function joinGame() {
            const name = nameInput.value.trim();
            if (!name) return;
            me = { name, color: colorSelect.value };
            socket.emit("join", me);
            overlay.style.opacity = "0";
            setTimeout(() => overlay.style.visibility = "hidden", 500);
        }

        // Start game loop after initialization
        function startGameLoop() {
            if (gameLoopId) clearInterval(gameLoopId);
            gameLoopId = setInterval(() => {
                if (!isActive) return;
                const head = { x: segments[0].x + dx, y: segments[0].y + dy };
                wrap(head);
                segments.unshift(head);
                segments.pop(); // Growth handled by server via "eat-response"
                socket.emit("move", { segments });

                foodItems.forEach((f, index) => {
                    if (head.x === f.x && head.y === f.y) {
                        socket.emit("eat", { foodIndex: index });
                    }
                });
            }, 200); // 5 moves/sec
        }

        // Wrap around screen
        function wrap(head) {
            if (head.x >= canvas.width) head.x = 0;
            else if (head.x < 0) head.x = canvas.width - gridSize;
            if (head.y >= canvas.height) head.y = 0;
            else if (head.y < 0) head.y = canvas.height - gridSize;
        }

        // Draw game state
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            Object.values(players).forEach(p => {
                if (!p.active || !p.segments) return;
                ctx.fillStyle = p.color;
                p.segments.forEach(segment => {
                    ctx.fillRect(segment.x, segment.y, gridSize, gridSize);
                });
            });
            foodItems.forEach(f => {
                ctx.fillStyle = "yellow";
                ctx.fillRect(f.x, f.y, gridSize, gridSize);
                ctx.fillStyle = "black";
                ctx.fillText(f.value, f.x + 2, f.y + gridSize - 2);
            });
        }

        // Update scoreboard
        function updateScoreboard() {
            playersList.innerHTML = "";
            Object.values(players)
                .filter(p => p.active)
                .sort((a, b) => b.score - a.score)
                .forEach(p => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td><span style="display: inline-block; width: 10px; height: 10px; background-color: ${p.color}; margin-right: 5px;"></span>${p.name}</td>
                        <td>${p.score}</td>
                    `;
                    if (p.name === me.name) row.style.backgroundColor = "#FFFF99";
                    playersList.appendChild(row);
                });
        }

        // Show question and food
        function showQuestion(question, food) {
            questionDiv.textContent = `Level ${question.level}: ${question.text}`;
            foodItems = food;
            draw();
        }

        // Disable taken colors
        function disableTakenColors(pl) {
            const takenColors = new Set(Object.values(pl).map(p => p.color));
            Array.from(colorSelect.options).forEach(option => {
                option.disabled = takenColors.has(option.value);
            });
        }

        // Socket event handlers
        socket.on("connect", () => console.log("Connected to server"));

        socket.on("init", ({ players: pl, question, food }) => {
            players = pl;
            updateScoreboard();
            showQuestion(question, food);
            disableTakenColors(pl);
            if (me.name && isActive) startGameLoop();
        });

        socket.on("players-update", pl => {
            players = pl;
            const meData = players[socket.id];
            if (meData) {
                segments = meData.segments;
                isActive = meData.active;
                if (!isActive && gameLoopId) {
                    clearInterval(gameLoopId);
                    alert("Game Over! You ate the wrong answer.");
                }
            }
            updateScoreboard();
            draw();
        });

        socket.on("question-data", ({ question, food }) => {
            showQuestion(question, food);
        });

        socket.on("eat-response", ({ correct, foodIndex }) => {
            if (!isActive) return;
            if (!correct) {
                socket.emit("game-over");
            }
        });

        // Handle direction changes
        document.addEventListener("keydown", e => {
            if (!isActive) return;
            if (e.key === "ArrowUp" && dy === 0) { dx = 0; dy = -gridSize; }
            else if (e.key === "ArrowDown" && dy === 0) { dx = 0; dy = gridSize; }
            else if (e.key === "ArrowLeft" && dx === 0) { dx = -gridSize; dy = 0; }
            else if (e.key === "ArrowRight" && dx === 0) { dx = gridSize; dy = 0; }
        });
    </script>
</body>
</html>
